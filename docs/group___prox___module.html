<!-- HTML header for doxygen 1.9.4-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ASURT DAQ 26: Proximity (Speed) Group</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&family=Roboto:wght@400&family=Roboto:wght@500&display=swap" rel="stylesheet">
</head>
<body>
<script type="module">
  // Load Mermaid first (MUST be in header)
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  // DARK MODE DETECTION (critical for Doxygen)
  const isDarkMode = 
    document.documentElement.classList.contains('dark') || 
    window.matchMedia('(prefers-color-scheme: dark)').matches;
  // ENHANCED THEME CONFIGURATION (with TEXT COLOR FIX)
  mermaid.initialize({
    startOnLoad: true,
    securityLevel: 'loose',
    theme: 'base',
    themeVariables: {
      // Keep your existing colors
      primaryColor: '#f4f4ff',
      secondaryColor: 'rgba(244,244,255,0.9)',
      tertiaryColor: '#F9FAFC',
      // CRITICAL TEXT COLOR FIXES (missing in your config)
      primaryTextColor: isDarkMode ? '#e0e0e0' : '#000',
      lineColor: isDarkMode ? '#707070' : '#666',
      edgeLabelBackground: isDarkMode ? '#3a3a3a' : '#fff',
      // SEQUENCE DIAGRAM SPECIFICS
      actorBkg: isDarkMode ? '#3a3a3a' : '#e6f2ff',
      actorBorder: isDarkMode ? '#888' : '#216fda',
      noteBkg: isDarkMode ? '#4a4a4a' : '#eef4ff',
      noteBorderColor: isDarkMode ? '#707070' : '#216fda'
    }
  });
  console.log(`Mermaid initialized for ${isDarkMode ? 'DARK' : 'LIGHT'} mode`);
</script>
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ASURT DAQ 26
   </div>
   <div id="projectbrief">Ain Shams University&#39;s Racing Team&#39;s Data Acquisition System 2026</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('group___prox___module.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">Proximity (Speed) Group </div></div>
</div><!--header-->
<div class="contents">

<p>Wheel RPM measurement and speed calculation using timer input capture and DMA.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 id="header-nested-classes" class="groupheader"><a id="nested-classes" name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:prox_5Frpm_5Fbuffer_5Ft" id="r_prox_5Frpm_5Fbuffer_5Ft"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structprox__rpm__buffer__t.html">prox_rpm_buffer_t</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Structure holding previous and current RPM readings for all wheels.  <a href="structprox__rpm__buffer__t.html#details">More...</a><br /></td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 id="header-define-members" class="groupheader"><a id="define-members" name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:gab77352352fd7a39c6bd07b64492e9cef" id="r_gab77352352fd7a39c6bd07b64492e9cef"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#gab77352352fd7a39c6bd07b64492e9cef">PROX_CALCULATE_SPEED</a>(rpm1,  rpm2)</td></tr>
<tr class="memdesc:gab77352352fd7a39c6bd07b64492e9cef"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculates vehicle speed (km/h) from two wheel RPM values.  <br /></td></tr>
<tr class="memitem:gaf39ad4c760eb8d73e20ee25e65f82998" id="r_gaf39ad4c760eb8d73e20ee25e65f82998"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#gaf39ad4c760eb8d73e20ee25e65f82998">PROX_NO_OF_WHEELS</a>&#160;&#160;&#160;4</td></tr>
<tr class="memitem:gada9d56e623f748a32334fe5e2536dbd1" id="r_gada9d56e623f748a32334fe5e2536dbd1"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#gada9d56e623f748a32334fe5e2536dbd1">PROX_DMA_WHEEL_BUFFER_SIZE</a>&#160;&#160;&#160;10</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 id="header-enum-members" class="groupheader"><a id="enum-members" name="enum-members"></a>
Enumerations</h2></td></tr>
<tr class="memitem:gab4a9a23656c333baa80bb2c86116e1c2" id="r_gab4a9a23656c333baa80bb2c86116e1c2"><td class="memItemLeft" align="right" valign="top"><a id="gab4a9a23656c333baa80bb2c86116e1c2" name="gab4a9a23656c333baa80bb2c86116e1c2"></a>enum &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#gab4a9a23656c333baa80bb2c86116e1c2">wheel_buffer_t</a> { <b>FRONT_LEFT_BUFF</b>
, <b>FRONT_RIGHT_BUFF</b>
, <b>REAR_LEFT_BUFF</b>
, <b>REAR_RIGHT_BUFF</b>
 }</td></tr>
<tr class="memdesc:gab4a9a23656c333baa80bb2c86116e1c2"><td class="mdescLeft">&#160;</td><td class="mdescRight">Identifiers for wheel DMA buffers. <br /></td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 id="header-func-members" class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ga77a5fe4cb54486b937ee395a097146e0" id="r_ga77a5fe4cb54486b937ee395a097146e0"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ga77a5fe4cb54486b937ee395a097146e0">Prox_Init</a> (TIM_HandleTypeDef *htim, DMA_HandleTypeDef *hdma[4])</td></tr>
<tr class="memdesc:ga77a5fe4cb54486b937ee395a097146e0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize the proximity sensor system.  <br /></td></tr>
<tr class="memitem:ga5080505c7784b45fcee6c1fe3b0e11ec" id="r_ga5080505c7784b45fcee6c1fe3b0e11ec"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ga5080505c7784b45fcee6c1fe3b0e11ec">Prox_Task</a> (void *pvParameters)</td></tr>
<tr class="memdesc:ga5080505c7784b45fcee6c1fe3b0e11ec"><td class="mdescLeft">&#160;</td><td class="mdescRight">Periodic FreeRTOS task to read DMA buffers, calculate RPM and speed, and publish CAN messages.  <br /></td></tr>
</table>
<a name="details" id="details"></a><h2 id="header-details" class="groupheader">Detailed Description</h2>
<p>Wheel RPM measurement and speed calculation using timer input capture and DMA. </p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md19"></a>
Overview</h2>
<p>This group handles the initialization and periodic processing of proximity sensors attached to the wheels. It calculates wheel RPM from timer input capture data transferred via DMA, handles low-speed and stopped conditions, and publishes wheel RPM and speed data over CAN.</p>
<p>Timer input events triggered by 4 nails mounted on each wheel passing a proximity sensor. Each nail generates an input capture event, so each full wheel rotation produces 4 captures.</p>
<p>Timer input captures are transferred via DMA into buffers of size 10 elements per wheel. The buffer size is chosen to prevent overflow caused by slow wheel rotation (calculations are shown below), ensuring the system resets and clears the buffer before it wraps.</p>
<p>At very slow speeds, capture events are spaced far apart, increasing the risk of the DMA buffer filling slowly and overflowing. By periodically processing and clearing these buffers, the system prevents overflow and maintains accurate RPM readings.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md20"></a>
Workflow</h3>
<p><span class="tt">Prox_Task</span> does the following periodically for each wheel:</p><ul>
<li>Processes valid captures and computes RPM from timer count differences.</li>
<li>Detects slow or stopped wheels by monitoring buffer activity.</li>
<li>Resets DMA buffers to avoid stale data and overflow.</li>
<li>Calculates vehicle speed from front wheel RPM averages and tire circumference.</li>
<li>Sends RPM and speed CAN messages only on significant change to reduce bus load.</li>
</ul>
<hr  />
<h2 class="doxsection"><a class="anchor" id="autotoc_md22"></a>
Calculations</h2>
<p>In this section, critical calculations will be covered.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md23"></a>
Timer Prescaled Frequency</h3>
<p>Timer prescaled frequency is   </p><p class="formulaDsp">
<picture><source srcset="form_6_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaDsp" alt="\[    \frac{2\times\textrm{(PCLK1 Frequency Hz)}}{\textrm{Prescalar}} = \frac{2\times(18\textrm{E}6)}{1200} = 30 \textrm{KHz,} 
\]" src="form_6.png" width="288" height="29"/></picture>
</p>
<p> which is abslotely more than double the wheel frequency (2 * 132 Hz) at top speed (150 km/h).</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md24"></a>
Minimum Buffer Size</h3>
<p>The minimum buffer size needed to capture this top speed could be calculated by calculating how many input captures would occur during the RTOS delay. To do so, we can divide the delay time in seconds by the time between 2 input captures at top speed, giving us the following formula   </p><p class="formulaDsp">
<picture><source srcset="form_7_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaDsp" alt="\[    \textrm{(no. of input captures)} = \frac{\textrm{(RTOS delay ticks)} \times \textrm{(Event Frequency Hz)}}{\textrm{(RTOS Frequency Hz)}} = \frac{7\times 132}{200} = 4.62 \; \mathrm{(round\ up)} \; = 5 
\]" src="form_7.png" width="573" height="31"/></picture>
</p>
<p> Hence, the minimum buffer size is 5, and I chose it to be 10 for saftey.</p>
<dl class="section attention"><dt>Attention</dt><dd>You must round the answer up (not approximate) and at least add 1.</dd></dl>
<h3 class="doxsection"><a class="anchor" id="autotoc_md25"></a>
Minimum (Stop) Speed</h3>
<p>The minimum time window for proximity to capture 2 successive input event is set to   </p><p class="formulaDsp">
<picture><source srcset="form_8_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaDsp" alt="\[    \frac{\textrm{ (RTOS Delay Ticks) } \times \textrm{ (slow counter max) }}{\textrm{ (RTOS Frequency Hz) }}  = \frac{7 \times 20}{200} = 0.7 \textrm{sec} 
\]" src="form_8.png" width="353" height="31"/></picture>
</p>
<p> Since this time corresponds to a quarter turn, we should multiply it by 4 to get the time of a full rotation, yielding 2.8 seconds. Therefore, the lowest capturable RPM, or in other words, the "wheel stopped" RPM is 60 / 2.8 = 21.4 RPM.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md26"></a>
Overflow Check</h3>
<p>To ensure no overflows occur, we will use the maximum time between 2 successive captures (the 0.7 seconds calculated in the previous section). The 0.7 seconds correspond to 0.7 * 30E3 = 21,000 ticks. Since a buffer element is of type <span class="tt">uint16_t</span>, its maximum value is 65,535, which is more than the 2 * 21,000 ticks needed. (assuming the worst case, the first capture will take place at tick 20,999, and the second at 41,999, so we need at least double the ticks calculated.) Thus, an overflow will not occur.</p>
<dl class="section note"><dt>Note</dt><dd>Generally speaking, any frequency between 46 kHz and 2 * 132 Hz should "theoretically" work, but the lower the frequency, the less stable high-speed readings will become.</dd></dl>
<a name="doc-define-members" id="doc-define-members"></a><h2 id="header-doc-define-members" class="groupheader">Macro Definition Documentation</h2>
<a id="gab77352352fd7a39c6bd07b64492e9cef" name="gab77352352fd7a39c6bd07b64492e9cef"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gab77352352fd7a39c6bd07b64492e9cef">&#9670;&#160;</a></span>PROX_CALCULATE_SPEED</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define PROX_CALCULATE_SPEED</td>
          <td>(</td>
          <td class="paramtype"></td>          <td class="paramname"><span class="paramname"><em>rpm1</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"></td>          <td class="paramname"><span class="paramname"><em>rpm2</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">((((rpm1 + rpm2) / 2.0) * DAQ_TIRE_CIRCUMFERENCE * 60.0) / 1000.0)</div>
</div><!-- fragment -->
<p>Calculates vehicle speed (km/h) from two wheel RPM values. </p>
<p>Uses the average of two wheel RPMs, multiplies by the tire circumference, and converts from revolutions per minute to kilometers per hour.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">rpm1</td><td>RPM of the first wheel. </td></tr>
    <tr><td class="paramname">rpm2</td><td>RPM of the second wheel. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Calculated speed in km/h. </dd></dl>

</div>
</div>
<a id="gada9d56e623f748a32334fe5e2536dbd1" name="gada9d56e623f748a32334fe5e2536dbd1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gada9d56e623f748a32334fe5e2536dbd1">&#9670;&#160;</a></span>PROX_DMA_WHEEL_BUFFER_SIZE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define PROX_DMA_WHEEL_BUFFER_SIZE&#160;&#160;&#160;10</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Size of DMA buffer for each wheel's input capture readings. </p>

</div>
</div>
<a id="gaf39ad4c760eb8d73e20ee25e65f82998" name="gaf39ad4c760eb8d73e20ee25e65f82998"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gaf39ad4c760eb8d73e20ee25e65f82998">&#9670;&#160;</a></span>PROX_NO_OF_WHEELS</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define PROX_NO_OF_WHEELS&#160;&#160;&#160;4</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Number of wheels monitored by the proximity sensor system. </p>

</div>
</div>
<a name="doc-func-members" id="doc-func-members"></a><h2 id="header-doc-func-members" class="groupheader">Function Documentation</h2>
<a id="ga77a5fe4cb54486b937ee395a097146e0" name="ga77a5fe4cb54486b937ee395a097146e0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga77a5fe4cb54486b937ee395a097146e0">&#9670;&#160;</a></span>Prox_Init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Prox_Init </td>
          <td>(</td>
          <td class="paramtype">TIM_HandleTypeDef *</td>          <td class="paramname"><span class="paramname"><em>htim</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">DMA_HandleTypeDef *</td>          <td class="paramname"><span class="paramname"><em>hdma</em></span>[4]&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize the proximity sensor system. </p>
<p>Starts timer input capture with DMA for all wheels.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">htim</td><td>Pointer to timer handle used for input capture. </td></tr>
    <tr><td class="paramname">hdma</td><td>Array of pointers to DMA handles for each wheel. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="ga5080505c7784b45fcee6c1fe3b0e11ec" name="ga5080505c7784b45fcee6c1fe3b0e11ec"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga5080505c7784b45fcee6c1fe3b0e11ec">&#9670;&#160;</a></span>Prox_Task()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Prox_Task </td>
          <td>(</td>
          <td class="paramtype">void *</td>          <td class="paramname"><span class="paramname"><em>pvParameters</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Periodic FreeRTOS task to read DMA buffers, calculate RPM and speed, and publish CAN messages. </p>
<p>Handles low-speed detection by counting slow readings, resets DMA buffers, and sends CAN messages only when meaningful RPM changes are detected.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">pvParameters</td><td>Unused task parameters. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- HTML footer for doxygen 1.9.4-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
<script>
mermaid.initialize({
  startOnLoad: true,
  theme: 'dark'
});
</script>
</body>
</html>
